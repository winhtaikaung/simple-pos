<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point of Sale System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clifford: '#da373d',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: #333;
            color: #fff;
            padding: 10px;
            text-align: center;
        }

        .view_container {
            display: flex;
            flex: 1;
            padding: 10px;
        }

        .pos-screen {
            display: flex;
            /* Changed to flex */
            gap: 10px;
            width: 100%;
            /* Ensure it takes full width */
        }

        .cashier-view {
            flex: 2;
            /* Takes 2/3 of the space */
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }

        .item-list {
            flex: 1;
            /* Takes 1/3 of the space */
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 768px) {
            .pos-screen {
                flex-direction: column;
                /* Stack on smaller screens */
            }

            .cashier-view,
            .item-list {
                flex: 1;
                /* Take full width on smaller screens */
            }
        }



        .menu-icon {
            font-size: 16px;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .actions button {
            padding: 10px;
            border: none;
            background: #444;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }

        .actions button:hover {
            background: #555;
        }

        /* Add this CSS */
        .overflow-x-auto,
        .item-list .overflow-x-auto {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .cashier-view tbody,
        .item-list tbody {
            display: block;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
            /* Adjust 150px as needed for header, padding, etc. */
        }

        .cashier-view thead,
        .item-list thead,
        .cashier-view tfoot,
        .item-list tfoot {
            display: block;
        }

        .cashier-view thead tr,
        .item-list thead tr,
        .cashier-view tfoot tr,
        .item-list tfoot tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .cashier-view tbody tr,
        .item-list tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
    </style>
</head>

<body>
    <div id="loadDataScreen" class="flex justify-center items-center h-screen">
        <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Load Initial Data</h2>
            <p class="text-gray-700 mb-4 text-center">Please upload a JSON file containing items and user data to
                start.</p>
            <input type="file" id="initialDataFile" accept="application/json"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <div class="flex items-center justify-between mt-4">
                <button
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                    onclick="navigateTo('#load-data')">
                    Load Data
                </button>
            </div>
        </div>
    </div>
    <div id="loginPage" class="hidden flex justify-center items-center h-screen">
        <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="username">
                        Username
                    </label>
                    <input
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        id="username" value="user1" type="text" placeholder="Username" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                        Password
                    </label>
                    <input
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                        id="password" value="password1" type="password" placeholder="******************" required>
                </div>
                <div class="flex items-center justify-between">
                    <button
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                        type="submit">
                        Sign In
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="appContent" class="hidden h-screen overflow-hidden">
        <header>

            <div class="flex justify-between items-center">
                <div class="hidden lg:block text-white mr-4">
                    <span id="currentDate" class="block text-sm"></span>
                    <span id="currentTime" class="block text-lg font-semibold"></span>
                </div>
                <button class="lg:hidden focus:outline-none" onclick="toggleMenu()">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16">
                        </path>
                    </svg>
                </button>
                <div class="flex-grow text-center">
                    <span class="text-white text-xl font-semibold">Point of Sale System</span>
                </div>
                <div class="hidden lg:flex space-x-4">
                    <a href="#load-data" onclick="navigateTo('#load-data')" class="text-white hover:text-gray-300">Load
                        Data</a>
                    <a href="#load-data" onclick="alert('Function to be implemented')"
                        class="text-white hover:text-gray-300">Logout</a>
                    <a href="#add-item" onclick="navigateTo('#add-item')" class="text-white hover:text-gray-300">Add
                        Item</a>
                    <a href="#update-item" onclick="navigateTo('#update-item')"
                        class="text-white hover:text-gray-300">Update Item</a>
                    <a href="#remove-item" onclick="navigateTo('#remove-item')"
                        class="text-white hover:text-gray-300">Remove Item</a>
                </div>
            </div>
        </header>



        <div class="drawer-overlay" id="drawer-overlay" onclick="UI.toggleDrawer()"></div>


        <div id="menuDrawer"
            class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white transform -translate-x-full transition-transform duration-300 ease-in-out z-50">
            <div class="p-4">
                <h2 class="text-xl font-semibold mb-4">Menu</h2>
                <nav>
                    <ul>
                        <li class="mb-2">
                            <a href="#load-data" onclick="navigateTo('#load-data')"
                                class="flex items-center hover:text-gray-300">
                                <span class="menu-icon mr-2">üìÇ</span> Load Data
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#load-data" onclick="alert('Function to be implemented')"
                                class="flex items-center hover:text-gray-300">
                                <span class="menu-icon mr-2">üîí</span> Logout
                            </a>
                        </li>
                        </li>
                        <li class="mb-2">
                            <a href="#add-item" onclick="navigateTo('#add-item')"
                                class="flex items-center hover:text-gray-300">
                                <span class="menu-icon mr-2">‚ûï</span> Add Item
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#update-item" onclick="navigateTo('#update-item')"
                                class="flex items-center hover:text-gray-300">
                                <span class="menu-icon mr-2">‚úèÔ∏è</span> Update Item
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#remove-item" onclick="navigateTo('#remove-item')"
                                class="flex items-center hover:text-gray-300">
                                <span class="menu-icon mr-2">‚ùå</span> Remove Item
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        <div id="menuOverlay"
            class="fixed inset-0 bg-gray-500 opacity-0 pointer-events-none transition-opacity duration-300 z-40">
            <button class="absolute top-4 right-4 text-white text-2xl" onclick="toggleMenu()">
                √ó
            </button>
        </div>

        <div class="view_container min-w-full min-h-[95vh]">
            <div class="pos-screen">
                <div class="cashier-view">
                    <h3 class="text-lg font-semibold mb-2">Cashier View</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Item</th>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-right">
                                        Price</th>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-right">
                                        Quantity</th>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-right">
                                        Subtotal</th>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="cart"
                                class="bg-white divide-y divide-gray-200 h-[calc(100vh-40vh)] overflow-y-auto">
                                <!-- Items added to cart will appear here -->
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="3"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Tax</td>
                                    <td id="tax" class="px-3 py-2 text-left text-sm text-gray-700">$0.00</td>
                                    <td class="px-3 py-2 text-left text-sm font-semibold text-gray-900">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="3"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Discount</td>
                                    <td id="discount" class="px-3 py-2 text-left text-sm text-gray-700">$0.00</td>
                                    <td class="px-3 py-2 text-left text-sm font-semibold text-gray-900">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="3"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Total</td>
                                    <td id="total" class="px-3 py-2 text-left text-sm font-semibold text-gray-900">$0.00
                                    </td>
                                    <td class="px-3 py-2 text-left text-sm font-semibold text-gray-900">
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="actions mt-4">
                            <button onclick="UI.completeCheckout()"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Complete
                                Checkout</button>
                            <button onclick="startOver()"
                                class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Start Over
                            </button>

                        </div>
                    </div>

                </div>

                <div class="item-list">
                    <div class="flex justify-between items-center mb-2">


                        <input type="text" id="itemListSearch" placeholder="Search items..."
                            class="m-2 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
                            onclick="openItemDrawer('add')">Add Item</button>

                    </div>
                    <div class="overflow-x-auto">
                        <!-- <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ID</th>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Name</th>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Price</th>
                                    <th scope="col"
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="items" class="bg-white divide-y divide-gray-200">
                                
                            </tbody>
                        </table> -->

                        <div id="items"
                            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4 p-2 h-[calc(100vh-15vh)] overflow-y-auto">
                            <!-- Dynamic rows will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="itemDrawer"
            class="fixed top-0 right-0 h-full w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
            <div class="p-6">
                <h2 id="itemDrawerTitle" class="text-2xl font-semibold mb-4">Add Item</h2>
                <form id="itemForm">
                    <div class="mb-4">
                        <label for="itemId" class="block text-gray-700 text-sm font-bold mb-2">Item ID</label>
                        <input type="text" id="itemId"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="Enter Item ID" required>
                    </div>
                    <div class="mb-4">
                        <label for="itemName" class="block text-gray-700 text-sm font-bold mb-2">Item Name</label>
                        <input type="text" id="itemName"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="Enter Item Name" required>
                    </div>
                    <div class="mb-4">
                        <label for="itemPrice" class="block text-gray-700 text-sm font-bold mb-2">Item Price</label>
                        <input type="number" id="itemPrice"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="Enter Item Price" required>
                    </div>
                    <!-- ADD THIS SECTION -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Barcode</label>
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-gray-700">
                                    <!-- Barcode will be displayed here -->
                                    <svg id="barcodeDisplay"></svg>
                                </div>

                            </div>

                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Barcode</label>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-700 text-sm mt-1">Item ID: <span id="barcodeItemId"
                                        class="font-bold"></span></p>

                            </div>

                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Barcode</label>
                        <div class="flex items-center justify-between">
                            <div>
                                <button type="button"
                                    class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
                                    onclick="openBarcodeModal()">Print Barcode</button>
                                <!-- ADD THIS BUTTON -->
                                <button type="button"
                                    class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded ml-2"
                                    onclick="refreshBarcode()">Refresh Barcode</button>
                                <!-- END OF ADDED BUTTON -->
                            </div>

                        </div>
                    </div>

                    <!-- END OF ADDED SECTION -->


                    <div class="flex justify-end space-x-2">
                        <button type="button"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded"
                            onclick="closeItemDrawer()">Cancel</button>
                        <button type="submit"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="itemDrawerOverlay"
            class="fixed inset-0 bg-gray-500 opacity-0 pointer-events-none transition-opacity duration-300 z-40">
            <!-- ADD THIS MODAL -->
            <div id="barcodeModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">‚Äã</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
                        role="dialog" aria-modal="true" aria-labelledby="modal-headline">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-headline">
                                Print Barcode
                            </h3>
                            <div class="mt-2 flex justify-center">
                                <svg id="barcodeModalDisplay">
                                    <!-- Barcode will be displayed here -->
                                </svg>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                                onclick="closeBarcodeModal()">
                                Cancel
                            </button>
                            <button type="button"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                                onclick="printBarcode()">
                                Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->


        <div id="paymentModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">‚Äã</span>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
                    role="dialog" aria-modal="true" aria-labelledby="modal-headline">
                    <form id="paymentForm">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-headline">
                                Enter Payment Amount
                            </h3>

                            <!-- Display Total Amount -->
                            <div class="mt-2">
                                <p class="text-3xl font-bold text-gray-800">Total: <span id="paymentModalTotal"></span>
                                </p>
                            </div>

                            <div class="mt-2">
                                <input type="number" step="0.01" id="paymentInput" placeholder="Enter amount"
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div id="changeDisplay" class="mt-4 text-gray-700"></div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm"
                                onclick="completePayment()">
                                Payment Received
                            </button>
                            <button type="button"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-orange-600 text-base font-medium text-white hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm"
                                onclick="calculateChange()">
                                Calc
                            </button>
                            <button type="button"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                                onclick="closePaymentModal()">
                                Cancel
                            </button>

                            <button type="button" onclick="UI.printVoucher()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Print
                                Voucher</button>

                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script>
            // --- Application Logic ---
            // --- Data and State ---
            let storedTransactions = localStorage.getItem('transactions');
            let transactions = {};
            if (storedTransactions) {
                transactions = JSON.parse(storedTransactions);
            }
            let items = [];
            let originalItems = [];
            let users = [];
            let isLoggedIn = false;
            let loggedInUser = null;
            let dataLoaded = false;
            let editingIndex = null;
            let totalAmount = 0;
            let cartItems = [];
            let barcodeTimeout = null;
            // --- Development Data Loading Logic

            function __loadJsonData(callback) {
                try {
                    // By Pass Debugging
                    // const data = JSON.parse(event.target.result);

                    const data = { items: [...Array(10)].map((_, i) => ({ "name": `Item ${i + 1}`, "price": Math.floor(Math.random() * (1000 - 100) + 100) / 100 })), users: [...Array(30)].map((_, i) => ({ "name": `user${i + 1}`, "password": `password${i + 1}` })) }

                    if (data.items && data.users) {
                        items = data.items.map((i, idx) => ({ ...i, "id": idx + 1 }));
                        users = data.users;
                        originalItems = [...items];
                        dataLoaded = true;
                        callback(null, { items, users }); // Pass data to callback
                    } else {
                        callback('Invalid JSON structure. Expected "items" and "users" arrays.');
                    }
                } catch (err) {
                    callback('Invalid JSON file');
                }
            }

            // --- Data Loading and Management ---
            function loadJSONData(file, callback) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        if (data.items && data.users) {
                            items = data.items.map((i, idx) => ({ ...i, "id": idx + 1 }));
                            users = data.users;
                            originalItems = [...items];
                            dataLoaded = true;
                            callback(null, { items, users }); // Pass data to callback
                        } else {
                            callback('Invalid JSON structure. Expected "items" and "users" arrays.');
                        }
                    } catch (err) {
                        callback('Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }

            function addItem(itemData) {
                items.push(itemData);
                originalItems = [...items];
            }

            function updateItem(index, itemData) {
                items[index] = itemData;
                originalItems = [...items];
            }

            function removeItem(index) {
                items.splice(index, 1);
                originalItems = [...items];
            }

            function searchItemsFromList(searchTerm) {
                if (searchTerm) {
                    return originalItems.filter(item =>
                        item.name.toLowerCase().includes(searchTerm) || `${item.id}`.toLowerCase().includes(searchTerm)
                    );
                } else {
                    return [...originalItems];
                }
            }

            // --- Cart Management ---
            function addToCart(index, quantity) {
                const item = items[index];
                const existingCartItemIndex = cartItems.findIndex(cartItem => cartItem.id === item.id);

                if (existingCartItemIndex > -1) {
                    cartItems[existingCartItemIndex].quantity += quantity;
                } else {
                    cartItems.push({ ...item, quantity });
                }
            }

            function editCartItem(itemId, newQuantity) {
                const cartItemIndex = cartItems.findIndex(item => item.id === itemId);
                if (cartItemIndex > -1) {
                    cartItems[cartItemIndex].quantity = newQuantity;
                }
            }

            function deleteCartItem(itemId) {
                const cartItemIndex = cartItems.findIndex(item => item.id === itemId);
                if (cartItemIndex > -1) {
                    cartItems.splice(cartItemIndex, 1);
                }
            }

            function clearCart() {
                cartItems = [];
            }

            // --- Calculations ---
            function calculateTotals() {
                let total = 0;
                cartItems.forEach(item => {
                    total += item.price * item.quantity;
                });
                const tax = total * 0.1;
                const discount = total > 100 ? total * 0.1 : 0;
                totalAmount = total + tax - discount;
                return { total, tax, discount, totalAmount };
            }

            // --- User Authentication ---
            function loginUser(username, password) {
                const user = users.find(user => user.name === username && user.password === password);
                if (user) {
                    isLoggedIn = true;
                    loggedInUser = username;
                    return true;
                }
                return false;
            }

            function logoutUser() {
                isLoggedIn = false;
                loggedInUser = null;
            }

            // --- Getters ---
            function getItems() {
                return items;
            }

            function getCartItems() {
                return cartItems;
            }

            function getLoginStatus() {
                return { isLoggedIn, loggedInUser, dataLoaded };
            }

            function setItemEditingIndex(index) {
                editingIndex = index;
            }

            function getItemEditingIndex() {
                return editingIndex;
            }

            function resetItems() {
                items = [...originalItems];
            }

            function recordTransaction(cartItems) {
                const now = new Date();
                const dateKey = now.toISOString().split('T')[0]; // Get date in YYYY-MM-DD format
                const transactionId = Date.now(); // Unique ID for the transaction
                const transactionItems = cartItems.map(item => `${item.id}|${item.name}|${item.quantity}|${item.price}`).join(',');

                if (!transactions[dateKey]) {
                    transactions[dateKey] = [];
                }

                transactions[dateKey].push({
                    id: transactionId,
                    itm: transactionItems
                });

                // Save to local storage
                localStorage.setItem('transactions', JSON.stringify(transactions));
            }

            // --- UI Logic ---
            // --- UI Elements ---
            const loadDataScreen = document.getElementById('loadDataScreen');
            const loginPage = document.getElementById('loginPage');
            const appContent = document.getElementById('appContent');
            const menuDrawer = document.getElementById('menuDrawer');
            const menuOverlay = document.getElementById('menuOverlay');
            const drawer = document.getElementById('drawer');
            const drawerOverlay = document.getElementById('drawer-overlay');
            const itemsContainer = document.getElementById('items');
            const cart = document.getElementById('cart');
            const taxDisplay = document.getElementById('tax');
            const discountDisplay = document.getElementById('discount');
            const totalDisplay = document.getElementById('total');
            const searchModal = document.getElementById('searchModal');
            const searchInput = document.getElementById('searchInput');
            const itemListSearch = document.getElementById('itemListSearch');
            const itemDrawer = document.getElementById('itemDrawer');
            const itemDrawerOverlay = document.getElementById('itemDrawerOverlay');
            const itemDrawerTitle = document.getElementById('itemDrawerTitle');
            const itemForm = document.getElementById('itemForm');
            const loginForm = document.getElementById('loginForm');
            const paymentForm = document.getElementById('paymentForm');
            const paymentModal = document.getElementById('paymentModal');
            const paymentInput = document.getElementById('paymentInput');
            const changeDisplay = document.getElementById('changeDisplay');
            // ADD THESE ELEMENTS
            const barcodeDisplay = document.getElementById('barcodeDisplay');
            const barcodeItemId = document.getElementById('barcodeItemId');
            const barcodeModal = document.getElementById('barcodeModal');
            const barcodeModalDisplay = document.getElementById('barcodeModalDisplay');
            // END OF ADDED ELEMENTS

            // --- UI State Management ---
            function checkLoginStatus() {
                const { isLoggedIn, dataLoaded } = getLoginStatus();
                if (!dataLoaded) {
                    showLoadDataScreen();
                } else if (!isLoggedIn) {
                    showLoginPage();
                } else {
                    showAppContent();
                }
            }

            function showLoadDataScreen() {
                loadDataScreen.classList.remove('hidden');
                loginPage.classList.add('hidden');
                appContent.classList.add('hidden');
            }

            function showLoginPage() {
                loadDataScreen.classList.add('hidden');
                loginPage.classList.remove('hidden');
                appContent.classList.add('hidden');
            }

            function showAppContent() {
                loadDataScreen.classList.add('hidden');
                loginPage.classList.add('hidden');
                appContent.classList.remove('hidden');
            }

            function toggleMenu() {
                menuDrawer.classList.toggle('-translate-x-full');
                menuOverlay.classList.toggle('opacity-0');
                menuOverlay.classList.toggle('pointer-events-none');
                menuOverlay.classList.toggle('opacity-75');
                menuOverlay.classList.toggle('pointer-events-auto');
            }

            function toggleDrawer() {
                drawer.classList.toggle('open');
                drawerOverlay.classList.toggle('active');
            }

            function navigateTo(hash) {
                window.location.hash = hash;
                handleRouting();
                toggleDrawer();
            }

            function handleRouting() {
                const hash = window.location.hash;
                switch (hash) {
                    case '#load-data':
                        loadData();
                        break;
                    case '#add-item':
                        openItemDrawer('add');
                        break;
                    case '#update-item':
                        openItemDrawer('edit');
                        break;
                    default:
                        console.log('Route not recognized:', hash);
                }
            }

            window.addEventListener('hashchange', handleRouting);

            function renderItems(itemsToRender) {

                itemsContainer.innerHTML = '';
                const itemsToUse = itemsToRender || getItems(); // Use provided items or all items

                if (itemsToUse.length === 0) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'text-gray-500 text-center p-4';
                    placeholder.textContent = 'No items found.';
                    itemsContainer.appendChild(placeholder);
                } else {
                    itemsToUse.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-white rounded-lg shadow p-4 flex flex-col justify-between h-120 max-h-fit';
                        itemDiv.innerHTML = `
        <div onclick="UI.addToCart(${index})">
            <h4 class="font-semibold text-gray-800">${item.name}</h4>
            <p class="text-gray-600 text-sm">ID: ${item.id}</p>
            <p class="text-gray-600 text-sm">Price: $${item.price}</p>
        </div>
    `;
                        itemsContainer.appendChild(itemDiv);
                    });
                }
            }

            function renderCart() {
                cart.innerHTML = '';
                getCartItems().forEach((cartItem, index) => {
                    const subtotal = (cartItem.price * cartItem.quantity).toFixed(2);
                    const row = document.createElement('tr');
                    row.setAttribute('data-item-id', cartItem.id);
                    row.innerHTML = `
                <td class="px-3 py-2 text-left">${cartItem.name}</td>
                <td class="px-3 py-2 text-right">$${cartItem.price}</td>
                <td class="px-3 py-2 text-right">${cartItem.quantity}</td>
                <td class="px-3 py-2 text-right">$${subtotal}</td>
                <td class="px-3 py-2 text-center">
                    <button onclick="UI.editCartItem(${cartItem.id})">Edit</button>
                    <button onclick="UI.deleteCartItem(${cartItem.id})">Delete</button>
                </td>
            `;
                    cart.appendChild(row);
                });
            }

            function updateTotalsDisplay() {
                const { tax, discount, totalAmount } = calculateTotals();
                taxDisplay.textContent = `$${tax.toFixed(2)}`;
                discountDisplay.textContent = `$${discount.toFixed(2)}`;
                totalDisplay.textContent = `$${totalAmount.toFixed(2)}`;
            }

            function updateClock() {
                const now = new Date();
                const dateOptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

                const formattedDate = now.toLocaleDateString('en-US', dateOptions);
                const formattedTime = now.toLocaleTimeString('en-US', timeOptions);

                document.getElementById('currentDate').textContent = formattedDate;
                document.getElementById('currentTime').textContent = formattedTime;
            }

            function openItemDrawer(mode, index = null) {
                itemDrawer.classList.remove('translate-x-full');
                itemDrawerOverlay.classList.remove('opacity-0', 'pointer-events-none');
                itemDrawerOverlay.classList.add('opacity-75', 'pointer-events-auto');

                if (mode === 'add') {
                    itemDrawerTitle.textContent = 'Add Item';
                    itemForm.reset();
                    updateBarcodeDisplay('N');
                } else if (mode === 'edit') {
                    itemDrawerTitle.textContent = 'Edit Item';
                    const item = getItems()[index];
                    document.getElementById('itemId').value = item.id;
                    document.getElementById('itemName').value = item.name;
                    document.getElementById('itemPrice').value = item.price;
                    updateBarcodeDisplay(item.id);
                }
            }

            function closeItemDrawer() {
                itemDrawer.classList.add('translate-x-full');
                itemDrawerOverlay.classList.remove('opacity-75', 'pointer-events-auto');
                itemDrawerOverlay.classList.add('opacity-0', 'pointer-events-none');
                setItemEditingIndex(null);
            }

            function openPaymentModal() {
                paymentModal.classList.remove('hidden');
                paymentInput.value = '';
                changeDisplay.textContent = '';

                // Display the total amount in the modal
                const { totalAmount } = calculateTotals();
                document.getElementById('paymentModalTotal').textContent = `$${totalAmount.toFixed(2)}`;
            }

            function closePaymentModal() {
                paymentModal.classList.add('hidden');
            }

            function updateBarcodeDisplay(itemId) {
                barcodeDisplay.innerHTML = '';
                barcodeItemId.textContent = itemId;
                if (itemId) {
                    JsBarcode(barcodeDisplay, itemId, {
                        format: "CODE128",
                        displayValue: false,
                        width: 1.5,
                        height: 40
                    });
                }
            }

            // ADD THIS FUNCTION
            function refreshBarcode() {
                const itemId = document.getElementById('itemId').value;
                if (itemId.trim() === '') {
                    updateBarcodeDisplay('N.A');
                } else {
                    updateBarcodeDisplay(itemId);
                }
            }

            function openBarcodeModal() {
                barcodeModal.classList.remove('hidden');
                barcodeModalDisplay.innerHTML = '';
                const itemId = document.getElementById('itemId').value;
                JsBarcode(barcodeModalDisplay, itemId, {
                    format: "CODE128",
                    displayValue: true,
                    width: 2,
                    height: 80
                });
            }

            function closeBarcodeModal() {
                barcodeModal.classList.add('hidden');
            }

            function printBarcode() {
                const printWindow = window.open('', '', 'width=300,height=200');
                printWindow.document.open();
                printWindow.document.write(`
            <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                ${barcodeModalDisplay.innerHTML}
            </div>
        `);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
                closeBarcodeModal();
            }

            // --- Event Handlers ---
            function loadData() {
                const fileInput = document.getElementById('initialDataFile');
                const file = fileInput.files[0];
                if (file) {
                    loadJSONData(file, (error, data) => {
                        if (error) {
                            alert(error);
                        } else {
                            UI.renderItems();
                            checkLoginStatus();
                            alert('Data loaded successfully');
                        }
                    });
                }
            }

            function handleItemFormSubmit(event) {
                event.preventDefault();
                const id = document.getElementById('itemId').value;
                const name = document.getElementById('itemName').value;
                const price = document.getElementById('itemPrice').value;
                const editingIndex = getItemEditingIndex();

                if (editingIndex !== null) {
                    updateItem(editingIndex, { id, name, price });
                } else {
                    addItem({ id: +id, name, price });
                }
                UI.renderItems();
                closeItemDrawer();
            }

            function handleItemListSearch() {
                const searchTerm = itemListSearch.value.toLowerCase();
                const searchResults = searchItemsFromList(searchTerm);
                UI.renderItems(searchResults);
            }

            function handleLoginFormSubmit(event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (loginUser(username, password)) {
                    checkLoginStatus();
                } else {
                    alert('Invalid username or password');
                }
            }

            function handlePaymentFormSubmit(event) {
                event.preventDefault();
                console.log("event")
                UI.calculateChange();
            }

            function calculateChange() {
                const payment = parseFloat(paymentInput.value);
                if (isNaN(payment)) {
                    alert('Please enter a valid payment amount.');
                    return;
                }
                const { totalAmount } = calculateTotals();
                const change = payment - totalAmount;
                if (change > 0) {
                    changeDisplay.textContent = `Change: $${change.toFixed(2)}`;

                } else if (change == 0) {
                    changeDisplay.textContent = `Complete Payment`;
                } else {
                    changeDisplay.textContent = `Insufficient payment. Please add $${Math.abs(change).toFixed(2)} more.`;
                }
                return change;
            }

            function completePayment() {
                const change = calculateChange(); // Calculate change first
                if (change >= 0) {
                    completeCheckoutProcess();
                } else {
                    alert('Payment is not sufficient.');
                }
            }

            function completeCheckoutProcess() {
                recordTransaction(cartItems);

                alert('Checkout Complete!');
                clearCart();
                UI.renderCart();
                UI.updateTotalsDisplay();
                closePaymentModal();
            }

            // --- UI Object ---
            const UI = {
                renderItems: function (itemsToRender) {
                    renderItems(itemsToRender);
                },
                renderCart: function () {
                    renderCart();
                },
                updateTotalsDisplay: function () {
                    updateTotalsDisplay();
                },
                addItem: function () {
                    const id = prompt('Enter Item ID:');
                    const name = prompt('Enter Item Name:');
                    const price = prompt('Enter Item Price:');
                    if (id && name && price) {
                        addItem({ id: +id, name, price });
                        UI.renderItems();
                    }
                },
                editItem: function (index) {
                    setItemEditingIndex(index);
                    openItemDrawer('edit', index);
                },
                deleteItem: function (index) {
                    removeItem(index);
                    UI.renderItems();
                },
                addToCart: function (index) {
                    const quantity = 1 //parseInt(prompt('Enter quantity:'), 10);
                    if (!isNaN(quantity) && quantity > 0) {
                        addToCart(index, quantity);
                        UI.renderCart();
                        UI.updateTotalsDisplay();
                    } else {
                        alert('Invalid quantity');
                    }
                },
                editCartItem: function (itemId) {
                    const newQuantity = parseInt(prompt('Enter new quantity:'), 10);
                    if (!isNaN(newQuantity) && newQuantity > 0) {
                        editCartItem(itemId, newQuantity);
                        UI.renderCart();
                        UI.updateTotalsDisplay();
                    } else {
                        alert('Invalid quantity');
                    }
                },
                deleteCartItem: function (itemId) {
                    deleteCartItem(itemId);
                    UI.renderCart();
                    UI.updateTotalsDisplay();
                },
                completeCheckout: function () {
                    openPaymentModal();
                },
                startOver: function () {
                    if (confirm('Are you sure you want to cancel the checkout?')) {
                        clearCart();
                        UI.renderCart();
                        UI.updateTotalsDisplay();
                    }
                },
                printVoucher: function () {
                    const cartRows = document.querySelectorAll('#cart tr');
                    if (cartRows.length === 0) {
                        alert('No items in cart to print.');
                        return;
                    }

                    let voucherContent = `
        <div style="font-family: monospace; font-size: 12px;">
            <h2 style="text-align: center;">Voucher</h2>
            <hr style="border-top: 1px dashed #000; margin: 5px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="text-align: left; padding-bottom: 5px;">Item</th>
                        <th style="text-align: right; padding-bottom: 5px;">Qty</th>
                        <th style="text-align: right; padding-bottom: 5px;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
    `;

                    let total = 0;
                    getCartItems().forEach(item => {
                        const subtotal = (item.price * item.quantity).toFixed(2);
                        voucherContent += `
                    <tr>
                        <td style="text-align: left;">${item.name}</td>
                        <td style="text-align: right;">${item.quantity}</td>
                        <td style="text-align: right;">$${subtotal}</td>
                    </tr>
        `;
                        total += parseFloat(subtotal.slice(1));
                    });

                    const { tax, discount, totalAmount } = calculateTotals();

                    voucherContent += `
                </tbody>
                <tfoot>
                    <tr>
                        <td style="text-align: left; padding-top: 5px;" colspan="2">Tax:</td>
                        <td style="text-align: right; padding-top: 5px;">$${tax.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td style="text-align: left;" colspan="2">Discount:</td>
                        <td style="text-align: right;">$${discount.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;" colspan="2">Total:</td>
                        <td style="text-align: right; font-weight: bold;">$${totalAmount.toFixed(2)}</td>
                    </tr>
                </tfoot>
            </table>
            <hr style="border-top: 1px dashed #000; margin: 5px 0;">
            <p style="text-align: center;">Thank you for your purchase!</p>
            
            <p style="text-align: center; margin-top: 5px;">${new Date().toLocaleString()}</p>
            <p style="text-align: center; margin-top: 10px;">Served by: ${getLoginStatus().loggedInUser}</p>
        </div>
    `;

                    const printWindow = window.open('', '', 'width=300,height=400');
                    printWindow.document.open();
                    printWindow.document.write(voucherContent);
                    printWindow.document.close();
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                },
                calculateChange: function () {
                    calculateChange();
                }
            };

            // --- Initialization-- -
            __loadJsonData((error, data) => {
                if (error) {
                    alert(error);
                } else {
                    UI.renderItems();
                    loginUser = "user1"
                    isLoggedIn = true
                    checkLoginStatus();
                    alert('Data loaded successfully');
                }
            });

            itemForm.addEventListener('submit', handleItemFormSubmit);
            loginForm.addEventListener('submit', handleLoginFormSubmit);
            paymentForm.addEventListener('submit', handlePaymentFormSubmit);
            itemListSearch.addEventListener('input', handleItemListSearch);

            // Loopers
            setInterval(() => updateClock(), 1000);
            // checkLoginStatus();


        </script>
</body>

</html>